{% extends "base.html" %}
{% block body_attrs %}style="background-color: {{ bg_color|default:'#f7f7f8' }};"{% endblock %}

{% load static %}

{% block title %}
  {% if is_owner %}Dashboard | Linkfree{% else %}@{{ profile_user.username }} | Linkfree{% endif %}
{% endblock %}

{% block content %}

{# ==== CSS INLINE PER FORZARE LO STILE (funziona subito) ==== #}
<style>
  /* BOTTONI LINK = IDENTICI AL ‚Äú+ Nuovo link‚Äù */
  .app-btn{
    display:flex !important;
    align-items:center !important;
    justify-content:center !important;
    gap:10px !important;

    width:100% !important;
    max-width:360px !important;

    font-size:1.2rem !important;
    font-weight:700 !important;
    line-height:1 !important;
    text-transform:uppercase !important;

    padding:1rem 1.5rem !important;   /* ~ py-3 */
    border-radius:14px !important;
    border:0 !important;
    box-shadow:0 8px 20px rgba(0,0,0,.08) !important;

    color:#fff !important;
    text-decoration:none !important;
    transition:.15s ease-in-out;
  }
  .app-btn i{ font-size:1.25rem !important; line-height:1 !important; }
  .app-btn span{ font-size:1.2rem !important; font-weight:700 !important; line-height:1 !important; }

  /* HOVER */
  .app-btn:hover{ filter:brightness(1.05); transform:translateY(-1px); }

  /* COLORI BRAND (usa link-{{ item.tipo|lower }}) */
  .app-btn.link-instagram{ background:linear-gradient(45deg,#f09433,#e6683c,#dc2743,#cc2366,#bc1888) !important; color:#fff !important; }
  .app-btn.link-youtube{   background:#ff0000 !important; color:#fff !important; }
  .app-btn.link-tiktok{    background:#000 !important; color:#00f2ea !important; }
  .app-btn.link-twitter{   background:#111 !important; color:#fff !important; }
  .app-btn.link-website{   background:#0d6efd !important; color:#fff !important; }
  .app-btn.link-altro{     background:#6c757d !important; color:#fff !important; }
</style>

<div class="row justify-content-center">
  <div class="col-12 col-lg-8">

    <!-- FOTO PROFILO -->
    <div class="text-center mb-3">
      {% if is_owner %}
      <button class="border-0 bg-transparent p-0"
              data-bs-toggle="modal" data-bs-target="#avatarModal"
              style="width: 120px; height: 120px; border-radius: 50%; overflow: hidden; cursor:pointer;">
        {% if profile and profile.avatar %}
          <img src="{{ profile.avatar.url }}" alt="Avatar di {{ profile_user.username }}"
               class="object-fit-cover" style="width:100%; height:100%; border-radius:50%;">
        {% else %}
          <div class="d-flex justify-content-center align-items-center bg-secondary-subtle"
               style="width:100%; height:100%; border-radius:50%;">
            <i class="bi bi-plus-lg" style="font-size: 2.7rem; color:#6c757d;"></i>
          </div>
        {% endif %}
      </button>
      {% else %}
        {% if profile and profile.avatar %}
          <img src="{{ profile.avatar.url }}" alt="Avatar di {{ profile_user.username }}"
               class="rounded-circle object-fit-cover" style="width:120px; height:120px;">
        {% else %}
          <div class="rounded-circle d-inline-flex justify-content-center align-items-center bg-secondary-subtle"
               style="width:120px; height:120px;">
            <i class="bi bi-person fs-1 text-secondary"></i>
          </div>
        {% endif %}
      {% endif %}
    </div>

    <!-- LINK PUBBLICO + NUOVO LINK (solo owner) -->
    {% if is_owner %}
    <div class="card shadow-sm border-0 mb-3 share-card">
      <div class="card-body p-3">
        <div class="d-flex flex-column flex-md-row gap-2 align-items-stretch">
          <input id="shareLinkInput" type="text" class="form-control"
                 readonly value="{{ share_url }}" aria-label="Link pubblico">
          <button id="copyShareLinkBtn" class="btn btn-outline-secondary w-100 w-md-auto">
            Copia
          </button>
        </div>
        <small id="copyFeedback" class="text-success d-none">Link copiato!</small>
      </div>
    </div>

    <div class="text-center mb-4">
      <button class="btn btn-primary w-100 py-3 shadow-sm"
              style="max-width: 360px; font-size: 1.2rem; border-radius: 14px;"
              data-bs-toggle="modal" data-bs-target="#newLinkModal">
        + Nuovo link
      </button>
    </div>
    {% endif %}

    {% if is_owner %}
<form method="post" class="text-center my-3">
  {% csrf_token %}
  <input type="hidden" name="action" value="set_bg_color">
  <input type="color" name="bg_color" value="{{ profile.bg_color|default:'#f7f7f8' }}"
         class="form-control form-control-color mx-auto"
         title="Scegli colore sfondo"
         style="width:60px;height:60px;border-radius:50%;cursor:pointer;">
  <div class="mt-2">
    <button class="btn btn-outline-secondary btn-sm" type="submit">Salva colore</button>
    {% if profile.bg_color %}
      <button class="btn btn-link btn-sm text-decoration-none" type="submit" name="bg_color" value="">
        Reset
      </button>
    {% endif %}
  </div>
</form>
{% endif %}


    <!-- LISTA LINK -->
    {% if links %}
      <div class="vstack gap-3 mb-5">
        {% for item in links %}
          <div class="d-flex justify-content-center align-items-center gap-2">

            <!-- LINK COLORE APP + DIMENSIONI UGUALI -->
            <a class="app-btn link-{{ item.tipo|lower }} w-100"
               style="max-width: 360px;"
               href="{{ item.url }}" target="_blank" rel="noopener"
               role="button" aria-label="{{ item.get_tipo_display }}">
              {% if item.tipo == "youtube" %}
                <i class="bi bi-youtube"></i>
              {% elif item.tipo == "instagram" %}
                <i class="bi bi-instagram"></i>
              {% elif item.tipo == "tiktok" %}
                <i class="bi bi-music-note-beamed"></i>
              {% elif item.tipo == "twitter" %}
                <i class="bi bi-twitter-x"></i>
              {% elif item.tipo == "website" %}
                <i class="bi bi-globe"></i>
              {% else %}
                <i class="bi bi-link-45deg"></i>
              {% endif %}
              <span class="ms-2 fw-semibold text-uppercase">
                {{ item.get_tipo_display }}
              </span>
            </a>

            {% if is_owner %}
            <form method="post"
                  action="{% url 'link_delete' item.pk %}"
                  onsubmit="return confirm('Sicuro di voler eliminare il seguente link?');">
              {% csrf_token %}
              <button class="btn btn-outline-danger px-3"
                      style="border-width:2px;border-radius:14px;"
                      aria-label="Elimina link">üóëÔ∏è</button>
            </form>
            {% endif %}
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="card shadow-sm border-0 mb-5">
        <div class="card-body p-4 text-center text-muted">
          {% if is_owner %}
            Nessun link ancora. Premi ‚Äú+ Nuovo link‚Äù.
          {% else %}
            Nessun link pubblico disponibile.
          {% endif %}
        </div>
      </div>
    {% endif %}

  </div>
</div>

{% if is_owner %}
<!-- MODAL CREA LINK -->
<div class="modal fade" id="newLinkModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-fullscreen-sm-down">
    <div class="modal-content border-0">
      <div class="modal-header">
        <h5 class="modal-title">Crea nuovo link</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form method="post" novalidate>
        {% csrf_token %}
        <input type="hidden" name="action" value="create_link">
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Link (URL)</label>
            {{ form.url }}
          </div>
          <div class="mb-3">
            <label class="form-label">Tipologia</label>
            {{ form.tipo }}
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">Annulla</button>
          <button class="btn btn-primary" type="submit">Crea</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- MODAL AVATAR -->
<div class="modal fade" id="avatarModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-fullscreen-sm-down">
    <div class="modal-content border-0">
      <div class="modal-header">
        <h5 class="modal-title">Modifica immagine profilo</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <input type="hidden" name="action" value="upload_avatar">
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Seleziona immagine</label>
            {{ avatar_form.avatar }}
            <div class="form-text">JPG/PNG ‚Ä¢ Consigliato quadrato (es. 512√ó512)</div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">Annulla</button>
          <button class="btn btn-primary" type="submit">Salva</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- JS COPIA LINK -->
<script>
  (function() {
    const btn = document.getElementById('copyShareLinkBtn');
    const input = document.getElementById('shareLinkInput');
    const feedback = document.getElementById('copyFeedback');
    if (btn && input) {
      btn.addEventListener('click', async () => {
        try { await navigator.clipboard.writeText(input.value); }
        catch (e) { input.select(); document.execCommand('copy'); }
        feedback.classList.remove('d-none');
        setTimeout(() => feedback.classList.add('d-none'), 1800);
      });
    }
  })();
</script>
{% endif %}
{% endblock %}
